# Template metadata inline DSL

The `webbed_duck.server.template_metadata` module extracts structured route metadata
from SQL templates without affecting the rendered SQL. Inline directives live next
to the expressions they protect so reviewers can see why a guard exists while
reading the template.

## Call anatomy

Inline directives use call syntax inside template placeholders:

```jinja
{{ webbed_duck.validator(target, name, **options) }}
```

- `target` identifies the object being described, such as `parameters.limit`.
- `name` labels the validator rule that applies, for example `positive` or `range`.
- Additional keyword arguments become metadata options. Arguments must be literals
  so metadata can be collected without evaluating arbitrary code.

The call renders as an empty string, keeping the SQL passed to the database unchanged
while still advertising the guard to tooling and documentation.

## Example: `reference/inline_metadata`

* Template: `reference/inline_metadata.sql`

```sql
SELECT
    order_id,
    country_code,
    total_amount
FROM analytics.order_facts
WHERE country_code IN (
    {{ ctx.parameters.str.country }}
)
LIMIT {{ ctx.parameters.number.limit }}{{ webbed_duck.validator("parameters.limit", "positive", severity="error", hint="Limits must be positive") }}
AND {{ ctx.parameters.number.limit }} <= 1000{{ webbed_duck.validator(target="parameters.limit", name="range", min=1, max=1000) }}
```

### Inline directives captured from the template
- inline validator parameters.limit positive {"hint": "Limits must be positive", "severity": "error"}
- inline validator parameters.limit range {"max": 1000, "min": 1}

### Derived directives from validation manifests and whitelists
- validation validator parameters.country choices {"values": ["CA", "GB", "US"]}
- validation validator parameters.limit range {"max": 1000, "min": 1}
- validation whitelist parameters.str allowed {"label": "Allowed countries", "values": ["CA", "US"]}

### Route registry aggregation
`build_route_registry` merges inline annotations with cache invariants so API
consumers receive a complete description of each route. For this template the
registry includes:

**Invariants**
- region â†’ column=`region_code`, separator=`|`, case_insensitive=true

**All metadata directives**
- validation validator parameters.country choices {"values": ["CA", "GB", "US"]}
- inline validator parameters.limit positive {"hint": "Limits must be positive", "severity": "error"}
- inline validator parameters.limit range {"max": 1000, "min": 1}
- validation validator parameters.limit range {"max": 1000, "min": 1}
- validation whitelist parameters.str allowed {"label": "Allowed countries", "values": ["CA", "US"]}

This document is regenerated by the test suite, ensuring the examples stay in
sync with the actual parsing and registry behaviour.
